<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TP Messenger ‚ù§Ô∏è</title>

<style>
body{
  margin:0;
  font-family:'Segoe UI',Arial;
  background:linear-gradient(135deg,#ff9a9e,#fad0c4);
}

.app{
  max-width:500px;
  margin:auto;
  height:100vh;
  display:flex;
  flex-direction:column;
  background:#fff;
  box-shadow:0 0 20px rgba(0,0,0,0.2);
  border-radius:15px;
  overflow:hidden;
}

header{
  background:linear-gradient(45deg,#ff416c,#ff4b2b);
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:20px;
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.logo{
  width:32px;
  height:32px;
  background:white;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ff416c;
  font-weight:bold;
}

#login{
  display:flex;
  flex-direction:column;
  padding:20px;
  gap:12px;
}
#login input{
  padding:12px;
  border-radius:25px;
  border:1px solid #ddd;
  outline:none;
}
#login button{
  padding:12px;
  border:none;
  background:linear-gradient(45deg,#ff416c,#ff4b2b);
  color:white;
  border-radius:25px;
  font-weight:bold;
  cursor:pointer;
}

#chat{display:none;flex:1;flex-direction:column;}

.top-bar{
  display:flex;
  gap:10px;
  padding:10px;
  background:#ffe6eb;
}
.top-bar select{
  flex:1;
  padding:8px;
  border-radius:20px;
  border:none;
}
.top-bar button{
  border:none;
  background:#ff4b2b;
  color:#fff;
  border-radius:20px;
  padding:8px 12px;
  cursor:pointer;
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  background:url('https://www.transparenttextures.com/patterns/hearts.png');
}

.message{
  background:white;
  margin:8px 0;
  padding:10px 14px;
  border-radius:18px;
  max-width:75%;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.me{
  background:#ffd1dc;
  margin-left:auto;
}

.message img{
  max-width:160px;
  border-radius:12px;
  margin-top:5px;
}
audio{width:160px;margin-top:5px;}

.input-box{
  display:flex;
  padding:10px;
  background:#ffe6eb;
  gap:5px;
  align-items:center;
}
.input-box input{
  flex:1;
  padding:10px;
  border-radius:25px;
  border:none;
  outline:none;
}
.input-box button{
  padding:10px;
  border:none;
  background:linear-gradient(45deg,#ff416c,#ff4b2b);
  color:#fff;
  border-radius:50%;
  cursor:pointer;
}

.emoji{
  cursor:pointer;
  font-size:20px;
}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="logo">TP</div>
  TP Messenger ‚ù§Ô∏è
</header>

<div id="login">
  <input type="text" id="username" placeholder="Username"/>
  <input type="password" id="password" placeholder="Password"/>
  <button onclick="login()">Login / Register</button>
</div>

<div id="chat">
  <div class="top-bar">
    <select id="userSelect"></select>
    <button onclick="deleteChat()">üóëÔ∏è</button>
  </div>

  <div id="messages"></div>

  <div class="input-box">
    <span class="emoji" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="emoji" onclick="addEmoji('üòç')">üòç</span>
    <span class="emoji" onclick="addEmoji('üòò')">üòò</span>
    <input id="msgInput" placeholder="Type message..." />
    <input type="file" id="imgInput" accept="image/*" hidden onchange="sendImage()">
    <button onclick="document.getElementById('imgInput').click()">üì∏</button>
    <button onclick="recordVoice()">üé§</button>
    <button onclick="sendMessage()">‚û§</button>
  </div>
</div>
</div>

<script>
let username="", currentChat="All", mediaRecorder, audioChunks=[];

function getKey(){ return "tp_chat_"+currentChat; }

function login(){
  const u=document.getElementById("username").value;
  const p=document.getElementById("password").value;
  if(!u||!p){ alert("Enter username & password"); return; }

  let users=JSON.parse(localStorage.getItem("tp_users"))||{};
  if(users[u] && users[u]!==p){ alert("Wrong password!"); return; }

  users[u]=p;
  localStorage.setItem("tp_users",JSON.stringify(users));

  username=u;
  loadUserList();
  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="flex";
  loadMessages();
}

function loadUserList(){
  let users=Object.keys(JSON.parse(localStorage.getItem("tp_users"))||{});
  const sel=document.getElementById("userSelect");
  sel.innerHTML=`<option value="All">All Users</option>`;
  users.forEach(u=>{ if(u!==username) sel.innerHTML+=`<option>${u}</option>`; });
}

document.getElementById("userSelect").onchange=function(){
  currentChat=this.value;
  loadMessages();
}

function loadMessages(){
  const msgs=JSON.parse(localStorage.getItem(getKey()))||[];
  const box=document.getElementById("messages");
  box.innerHTML="";
  msgs.forEach(m=>{
    const div=document.createElement("div");
    div.className="message "+(m.user===username?"me":"");
    let content=`<b>${m.user}:</b> ${m.text||""}`;
    if(m.img) content+=`<br><img src="${m.img}">`;
    if(m.audio) content+=`<br><audio controls src="${m.audio}"></audio>`;
    div.innerHTML=content;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}

function sendMessage(){
  const text=document.getElementById("msgInput").value.trim();
  if(!text) return;
  saveMsg({user:username,text});
  document.getElementById("msgInput").value="";
}

function sendImage(){
  const file=document.getElementById("imgInput").files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=> saveMsg({user:username,img:e.target.result});
  reader.readAsDataURL(file);
}

function recordVoice(){
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder=new MediaRecorder(stream);
    mediaRecorder.start();
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    setTimeout(()=>mediaRecorder.stop(),3000);
    mediaRecorder.onstop=()=>{
      const blob=new Blob(audioChunks,{type:'audio/webm'});
      const reader=new FileReader();
      reader.onload=e=> saveMsg({user:username,audio:e.target.result});
      reader.readAsDataURL(blob);
    };
  });
}

function saveMsg(msg){
  let msgs=JSON.parse(localStorage.getItem(getKey()))||[];
  msgs.push(msg);
  localStorage.setItem(getKey(),JSON.stringify(msgs));
  loadMessages();
}

function addEmoji(e){ document.getElementById("msgInput").value+=e; }
function deleteChat(){ localStorage.removeItem(getKey()); loadMessages(); }
window.addEventListener("storage",loadMessages);
</script>
</body>
</html>
